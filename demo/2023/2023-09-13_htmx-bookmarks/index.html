<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Remote OpenGraph Meta Tags</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link rel="stylesheet" type="text/css" href="main.css" media=”screen” />
    <script src="https://unpkg.com/htmx.org@1.9.4" crossorigin="anonymous"></script>
    <script src="greet.js"></script>
</head>
<body>
<main class="container">
    <div id="meta-tags">
        <!-- This div will be populated with the meta tags -->
    </div>

    <button hx-get="https://dev.to/mfp22/10-tips-for-scaling-signals-1nap" hx-trigger="click" hx-swap="outerHTML" hx-target="#meta-tags">
        Fetch Meta Tags
    </button>
    <!--
        <button hx-get="https://dev.to/mfp22/10-tips-for-scaling-signals-1nap" hx-trigger="revealed" >
            Fetch Meta Tags
        </button>
    -->
</main>

<script>
    const OG_URL = 'og:url';
    const OG_IMAGE = 'og:image';
    const OG_TITLE = 'og:title';
    const OG_DESCRIPTION = 'og:description';
    function getOgItem(doc, property) {
        const tag = doc.querySelector(`meta[property="${property}"]`);
        return tag.getAttribute('content')
    }
    function extractOpenGraphMetaTags(html) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const result = {
            url: getOgItem(doc, OG_URL),
            title: getOgItem(doc, OG_TITLE),
            description: getOgItem(doc, OG_DESCRIPTION),
            image: getOgItem(doc, OG_IMAGE),
        }

        return result;
    }

    // Remove all extra htmx headers, re-add content-type.
    document.body.addEventListener('htmx:configRequest', function(event) {
        event.detail.headers = ''
        event.detail.headers['Content-Type'] = "application/x-www-form-urlencoded; charset=UTF-8"
    });

    document.addEventListener('htmx:beforeSwap', function (event) {
        console.log(event.detail);
        const og = extractOpenGraphMetaTags(event.detail.serverResponse);
        document.getElementById('meta-tags').innerHTML = `
            <article>
                <hgroup>
                    <h2>${og.title}</h2>
                    <h3>${og.description}</h3>
                </hgroup>
                <a href="${og.url}" target="_blank"><img src="${og.image}"></a>
            </article>
            `;
        event.detail.shouldSwap = false;
    });
</script>

</body>
</html>
